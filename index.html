<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Simulação — Gravidade T-M → T-54/T-55/T-56 + Destilaria</title>

<!-- Chart.js + plugin de zoom -->
<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1"></script>
<script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-zoom@2.0.1"></script>
<script>
  window.addEventListener('DOMContentLoaded', () => {
    if (window['chartjs-plugin-zoom']) Chart.register(window['chartjs-plugin-zoom']);
  });
</script>

<style>
  :root{
    --bg-0:#000; --bg-1:#0B0B0B; --bg-2:#121212;
    --ink-on-dark:#F5F6F7; --ink-muted:#B8BDC7;
    --border-dark:#262626; --grid-dark:#1B1B1B; --focus-ring:#EABF7A;
    --brand-gold:#D09D44; --brand-gold-bright:#EABF7A;
    --accent-green:#22C55E; --accent-blue:#60A5FA; --accent-amber:#F59E0B;
    --accent-red:#EF4444; --accent-gray:#374151;
    --radius:10px; --shadow-2:0 2px 10px rgba(0,0,0,.25);
    --series-1:var(--brand-gold-bright); --series-2:var(--brand-gold);
    --series-3:var(--ink-on-dark); --series-4:var(--ink-muted);
  }
  *{box-sizing:border-box}
  body{margin:0;background:var(--bg-0);color:var(--ink-on-dark);font:14px/1.45 Inter,system-ui,Segoe UI,Roboto,Helvetica,Arial}
  :focus-visible{outline:2px solid var(--focus-ring);outline-offset:2px;border-radius:6px}
  header.nav{display:flex;align-items:center;padding:14px 20px;background:var(--bg-2);border-bottom:1px solid var(--border-dark);position:sticky;top:0;z-index:10}
  .brand{display:flex;gap:10px;font-weight:600;align-items:center}
  .brand-logo{height:36px;width:auto;display:block}
  .grid{display:grid;gap:16px;grid-template-columns:repeat(12,1fr);padding:16px;max-width:1280px;margin:0 auto}
  .card{background:var(--bg-1);border:1px solid var(--border-dark);border-radius:var(--radius);padding:14px;box-shadow:var(--shadow-2)}
  .span-12{grid-column:span 12}.span-6{grid-column:span 6}
  @media (max-width:1100px){.span-6{grid-column:span 12}}
  .sub{color:var(--ink-muted);font-size:12px;padding:8px 20px 0}
  .controls{display:grid;grid-template-columns:repeat(12,1fr);gap:12px;align-items:end}
  .controls .field{grid-column:span 3;display:flex;flex-direction:column;gap:6px}
  .controls .field.w2{grid-column:span 2}
  .controls label{font-size:12px;color:var(--ink-muted)}
  .controls input{padding:8px 10px;border:1px solid var(--border-dark);border-radius:10px;background:var(--bg-1);color:var(--ink-on-dark)}
  .controls .actions{grid-column:span 12;display:flex;gap:8px;flex-wrap:wrap;margin-top:2px}
  .btn{background:var(--brand-gold);color:#000;border:0;border-radius:12px;padding:10px 16px;font-weight:700;cursor:pointer}
  .btn:hover{background:var(--brand-gold-bright)}
  .btn.secondary{background:transparent;color:var(--ink-on-dark);border:1px solid var(--border-dark)}
  .btn.secondary:hover{border-color:var(--brand-gold-bright);color:var(--brand-gold-bright)}
  .chartBox{position:relative;width:100%;height:280px}
  .toolbar{display:flex;gap:12px;align-items:center;flex-wrap:wrap;margin-top:10px;color:var(--ink-muted)}
  .toolbar input[type="range"]{width:180px;accent-color:var(--brand-gold-bright)}
  table{width:100%;border-collapse:collapse;color:var(--ink-on-dark)}
  th,td{border:1px solid var(--border-dark);padding:8px 10px;text-align:left;font-size:12px}
  th{background:var(--bg-2);font-weight:700}
  td.num{text-align:center}
  .pill{display:inline-block;padding:2px 8px;border-radius:999px;font-size:11px;font-weight:700;border:1px solid var(--border-dark);background:rgba(255,255,255,.02);color:var(--ink-on-dark)}
  .p-grav{border-color:color-mix(in oklab,var(--brand-gold) 50%,var(--border-dark));color:var(--brand-gold-bright)}
  .conv{margin-top:4px;font-size:11px;color:var(--ink-muted)} .conv b{color:var(--brand-gold)}
  .stats{grid-column:span 12;display:grid;grid-template-columns:repeat(12,1fr);gap:12px;margin-top:8px}
  .stat{grid-column:span 3;background:var(--bg-2);border:1px dashed var(--border-dark);border-radius:12px;padding:10px 12px}
  .stat .label{font-size:11px;color:var(--ink-muted)}
  .stat .value{font-size:16px;font-weight:700;margin-top:2px}
  .ok{color:var(--accent-green)} .warn{color:var(--accent-amber)} .err{color:var(--accent-red)}
  .ganttBox{width:100%;height:220px;border:1px solid var(--border-dark);border-radius:10px;background:var(--bg-2);overflow:hidden}
  .gantt-legend{display:flex;gap:12px;flex-wrap:wrap;font-size:12px;color:var(--ink-muted);margin:8px 0}
  .dot{display:inline-block;width:12px;height:12px;border-radius:2px;margin-right:6px;border:1px solid var(--border-dark)}
</style>
</head>
<body>
<header class="nav">
  <div class="brand">
    <img class="brand-logo" src="Logo%20da%20D%20%26%20J%20Engenharia.png" alt="D &amp; J Engenharia e Projetos" loading="eager" decoding="async">
    <span>Simulação de Transferência por Gravidade</span>
  </div>
</header>

<div class="sub">
  1 tanque envia por vez até o nível mínimo final; 1 tanque recebe por gravidade (nunca o mesmo que envia). Ao fim do ciclo, T-M descansa N horas e volta à altura configurada.
</div>

<div class="grid">
  <div class="card span-12">
    <div class="controls">
      <div class="field w2"><label>Horas de simulação</label><input id="hours" type="number" value="240" min="1" step="1"></div>
      <div class="field w2"><label>Descanso do T-M (h)</label><input id="restH" type="number" value="24" min="0" step="1"></div>
      <div class="field w2"><label>Altura de T-M (m)</label><input id="hT0" type="number" value="13.5" step="0.01"></div>
      <div class="field w2"><label>Diâmetro de T-M (m)</label><input id="dT0" type="number" value="65.465" step="0.001"></div>
      <div class="field w2"><label>Nível mín. para iniciar envio (m)</label><input id="minStart" type="number" value="5.0" step="0.01"></div>
      <div class="field w2"><label>Nível mín. ao final da hora (m)</label><input id="minEnd" type="number" value="2.5" step="0.01"></div>
      <div class="field w2"><label>Vazão destilaria (m³/h)</label><input id="flowDest" type="number" value="200" min="1" step="1"><div id="convQ" class="conv">≈ <b>— bpd</b></div></div>
      <div class="field w2"><label>Nível inicial T-54 (m)</label><input id="initT1" type="number" value="2.5" step="0.01"><div id="convT1" class="conv">Volume T-54: <b>— m³</b> • <b>— bbl</b></div></div>
      <div class="field w2"><label>Nível inicial T-55 (m)</label><input id="initT2" type="number" value="12.4" step="0.01"><div id="convT2" class="conv">Volume T-55: <b>— m³</b> • <b>— bbl</b></div></div>
      <div class="field w2"><label>Nível inicial T-56 (m)</label><input id="initT3" type="number" value="12.4" step="0.01"><div id="convT3" class="conv">Volume T-56: <b>— m³</b> • <b>— bbl</b></div></div>

      <div class="actions">
        <button id="runBtn" class="btn" onclick="simular()">Rodar simulação</button>
        <button class="btn secondary" onclick="resetar()">Resetar</button>
        <button class="btn secondary" onclick="resetarZoom()">Resetar Zoom</button>
      </div>

      <!-- KPIs -->
      <div class="stats">
        <div class="stat">
          <div class="label">Média por transferência</div>
          <div class="value"><span id="avgM3">—</span> m³ • <span id="avgBBL">—</span> bbl</div>
        </div>
        <div class="stat">
          <div class="label"># Transferências (gravidade)</div>
          <div class="value" id="numTrans">—</div>
        </div>
        <div class="stat">
          <div class="label">Status CDU</div>
          <div class="value" id="statusCDU">—</div>
        </div>
        <div class="stat">
          <div class="label">1ª interrupção após atendimento</div>
          <div class="value" id="firstStop">—</div>
        </div>
      </div>
    </div>
  </div>

  <!-- Gráficos -->
  <div class="card span-6">
    <strong style="display:block;margin-bottom:8px">T-M — Volume (m³)</strong>
    <div class="chartBox"><canvas id="chartT0Vol"></canvas></div>
    <div class="toolbar">
      <label>X início <input id="xStart1" type="range"></label>
      <label>X largura <input id="xSpan1" type="range"></label>
      <label>Y máx <input id="yMax1" type="range"></label>
    </div>
  </div>

  <div class="card span-6">
    <strong style="display:block;margin-bottom:8px">T-54 / T-55 / T-56 — Nível (m)</strong>
    <div class="chartBox"><canvas id="chartLevels"></canvas></div>
    <div class="toolbar">
      <label>X início <input id="xStart2" type="range"></label>
      <label>X largura <input id="xSpan2" type="range"></label>
      <label>Y máx <input id="yMax2" type="range"></label>
    </div>
  </div>

  <div class="card span-12">
    <strong style="display:block;margin-bottom:8px">Operações por hora</strong>
    <div class="chartBox"><canvas id="chartOps"></canvas></div>
    <div class="toolbar">
      <label>X início <input id="xStart3" type="range"></label>
      <label>X largura <input id="xSpan3" type="range"></label>
    </div>
  </div>

  <!-- Gantt -->
  <div class="card span-12">
    <strong style="display:block;margin-bottom:8px">Gantt Operacional (T-M & T-54/55/56)</strong>
    <div class="gantt-legend">
      <span><span class="dot" style="background:var(--brand-gold)"></span>T-M alimentando</span>
      <span><span class="dot" style="background:var(--accent-gray)"></span>T-M em espera</span>
      <span><span class="dot" style="background:var(--ink-muted)"></span>T-M em descanso</span>
      <span><span class="dot" style="background:var(--accent-green)"></span>T-54/55/56 enchendo</span>
      <span><span class="dot" style="background:var(--series-3)"></span>T-54/55/56 alimentando CDU</span>
      <span><span class="dot" style="background:#111"></span>Espera</span>
    </div>
    <div class="ganttBox"><svg id="ganttSvg" width="100%" height="220" role="img" aria-label="Gantt Operacional"></svg></div>
    <div class="toolbar">
      <label>Gantt início <input id="gStart" type="range"></label>
      <label>Gantt largura <input id="gSpan" type="range"></label>
    </div>
  </div>

  <!-- Plano hora a hora -->
  <div class="card span-12">
    <strong style="display:block;margin-bottom:8px">Plano hora a hora</strong>
    <table id="tabOps"><thead>
      <tr>
        <th>Janela (hora)</th><th>Resumo objetivo</th><th>Ações</th>
        <th class="num">T-M (m)</th><th class="num">T-54 (m)</th><th class="num">T-55 (m)</th><th class="num">T-56 (m)</th>
      </tr>
    </thead><tbody></tbody></table>
  </div>

  <!-- Transferências por Gravidade (consolidadas) -->
  <div class="card span-12">
    <strong style="display:block;margin-bottom:8px">Transferências T-M (Gravidade)</strong>
    <table id="tabTrans"><thead>
      <tr>
        <th>Início</th><th>Fim</th><th>Receptor</th><th class="num">Duração (h)</th>
        <th class="num">Total (m³)</th><th class="num">Total (bbl)</th>
        <th class="num">Vazão média (m³/h)</th><th class="num">Vazão média (bbl/h)</th>
      </tr>
    </thead><tbody></tbody></table>
  </div>
</div>

<script>
/* ===== Tema Chart.js ===== */
const cssVar = (name, fallback) => {
  const v = getComputedStyle(document.documentElement).getPropertyValue(name).trim();
  return v || fallback;
};
const C = {
  inkMuted: cssVar('--ink-muted', '#B8BDC7'),
  inkOn: cssVar('--ink-on-dark', '#F5F6F7'),
  grid: cssVar('--grid-dark', '#1B1B1B'),
  s1: cssVar('--series-1', '#EABF7A'),
  s2: cssVar('--series-2', '#D09D44'),
  s3: cssVar('--series-3', '#F5F6F7'),
  s4: cssVar('--series-4', '#B8BDC7'),
  green: cssVar('--accent-green', '#22C55E'),
  wait: '#111111',
  rest: cssVar('--ink-muted', '#B8BDC7'),
  tmWait: cssVar('--accent-gray', '#374151')
};
Chart.defaults.maintainAspectRatio = false;
Chart.defaults.animation = false;
Chart.defaults.responsive = true;
Chart.defaults.resizeDelay = 120;
Chart.defaults.font.family = "Inter, system-ui, Segoe UI, Roboto, Helvetica, Arial";
Chart.defaults.color = C.inkMuted;
const gridDark = { color: C.grid, lineWidth: 1 };
const tickCfg = { maxRotation: 0, autoSkip: true, maxTicksLimit: 12 };

/* ===== Geometrias fixas dos receptores ===== */
const dTr = 33.4;                 // m (T-54/55/56)
const hRmax = 21.3;               // m
const AR = Math.PI * (dTr/2)**2;  // área receptores

/* ===== Charts handlers ===== */
let chT0Vol = null, chLv = null, chOps = null;

/* ===== Utils ===== */
function clamp(n, lo, hi){ if (!Number.isFinite(n)) return lo; return Math.max(lo, Math.min(hi, n)); }
function flowByGravity(deltaH){
  if (!Number.isFinite(deltaH) || deltaH <= 0) return 0;
  let y = -1.2082 * deltaH * deltaH + 60.667 * deltaH + 58.475; // m³/h
  return y > 0 ? y : 0;
}
function hourLabelRange(h){
  const d = Math.floor(h/24), hh = h % 24, hh2 = (hh+1) % 24, d2 = d + (hh===23 ? 1 : 0);
  const pad = n => String(n).padStart(2,'0'); return `D+${d} ${pad(hh)}:00–D+${d2} ${pad(hh2)}:00`;
}
function hourStartLabel(h){
  const d = Math.floor(h/24), hh = h % 24;
  const pad = n => String(n).padStart(2,'0'); return `D+${d} ${pad(hh)}:00`;
}
const nameMap = {T1:'T-54', T2:'T-55', T3:'T-56'};
const BBL_M3 = 0.1589; // <<< única definição (m³ por bbl)
function fmt(n, fr=2){ return Number.isFinite(n) ? n.toLocaleString('pt-BR',{maximumFractionDigits:fr}) : '—'; }

/* ===== Entrada ===== */
function simular(){
  const hours    = +document.getElementById('hours').value;
  const restH    = +document.getElementById('restH').value;
  const hT0      = +document.getElementById('hT0').value;
  const dT0      = +document.getElementById('dT0').value;
  const minStart = +document.getElementById('minStart').value;
  const minEnd   = +document.getElementById('minEnd').value;
  const flowDest = +document.getElementById('flowDest').value;
  const initT1   = +document.getElementById('initT1').value;
  const initT2   = +document.getElementById('initT2').value;
  const initT3   = +document.getElementById('initT3').value;

  if (hours<=0 || restH<0 || hT0<=0 || dT0<=0 || minStart<0 || minEnd<0 || flowDest<=0){
    alert('Verifique os parâmetros.'); return;
  }

  const A0 = Math.PI * (dT0/2)**2; // área de T-M
  const dH_DEST = flowDest / AR;   // queda de nível por hora no tanque que envia (para CDU)

  document.getElementById('runBtn').disabled = true;
  try{ runSim({hours, restH, hT0, A0, minStart, minEnd, flowDest, dH_DEST, initT1, initT2, initT3}); }
  finally{ document.getElementById('runBtn').disabled = false; }
}
function resetar(){
  if (chT0Vol) { chT0Vol.destroy(); chT0Vol = null; }
  if (chLv)    { chLv.destroy();    chLv = null; }
  if (chOps)   { chOps.destroy();   chOps = null; }
  document.querySelector('#tabOps tbody').innerHTML = '';
  document.querySelector('#tabTrans tbody').innerHTML = '';
  document.getElementById('avgM3').textContent='—';
  document.getElementById('avgBBL').textContent='—';
  document.getElementById('numTrans').textContent='—';
  document.getElementById('statusCDU').textContent='—';
  document.getElementById('firstStop').textContent='—';
  document.getElementById('ganttSvg').innerHTML='';
}
function resetarZoom(){ [chT0Vol, chLv, chOps].forEach(ch => ch && ch.resetZoom && ch.resetZoom()); prepararSliders(0,0,true); }

/* ===== Simulador ===== */
function runSim(cfg){
  const {hours, restH, hT0, A0, minStart, minEnd, flowDest, dH_DEST, initT1, initT2, initT3} = cfg;

  let TM = hT0;
  let R = { T1:initT1, T2:initT2, T3:initT3 };
  let tRest = 0;
  let gravSessionFlag = false;
  let currentSender = null;
  let receiverActive = null;

  const EPS = 0.02;
  const lastSend = {T1:-Infinity, T2:-Infinity, T3:-Infinity};
  const lastRecv = {T1:-Infinity, T2:-Infinity, T3:-Infinity};

  const labelsLvl = [];  // 0..hours
  const sTMVol = [];
  const sT1=[]; const sT2=[]; const sT3=[];
  const labelsOps = [];  // 1..hours
  const sOpDest=[]; const sOpGrav=[];

  const stTM=[]; const stT1=[]; const stT2=[]; const stT3=[];

  const rows=[];
  const gravTransfers=[];

  let servedBefore=false;
  let firstStopAt=null;

  let inTrans=false;
  let transObj=null;

  // Snapshot h=0
  labelsLvl.push(0);
  sTMVol.push(TM*A0);
  sT1.push(R.T1); sT2.push(R.T2); sT3.push(R.T3);
  rows.push({ janela: 'Estado inicial (h=0)', resumo: 'Snapshot de níveis antes do ciclo.', actions:'—',
              TM: TM.toFixed(3), T1: R.T1.toFixed(3), T2: R.T2.toFixed(3), T3: R.T3.toFixed(3) });

  for (let h=1; h<=hours; h++){
    let actions=[], didGrav=false, sentFrom=null, flowGrav=0;

    if (tRest>0){
      tRest -= 1;
      if (tRest===0){
        TM = hT0;
        actions.push(`<span class="pill p-grav">T-M recarregado → ${hT0.toFixed(1)} m</span>`);
      }
    }

    // CDU
    const canActiveContinue = currentSender && (R[currentSender] - dH_DEST) >= minEnd;
    if (!canActiveContinue){
      const elegiveis = Object.keys(R)
        .filter(k => R[k] >= minStart && (R[k]-dH_DEST) >= minEnd)
        .sort((a,b)=>{
          const dif = R[b]-R[a];
          if (Math.abs(dif) > EPS) return dif;
          return (h - lastSend[b]) - (h - lastSend[a]);
        });
      currentSender = elegiveis[0] || null;
    }
    if (currentSender){
      R[currentSender] -= dH_DEST;
      lastSend[currentSender] = h;
      sentFrom = currentSender;
      actions.push(`<span class="pill">CDU ← ${nameMap[currentSender]} (${cfg.flowDest} m³)</span>`);
      servedBefore = true;
    } else {
      if (servedBefore && firstStopAt===null) firstStopAt = h-1;
    }
    sOpDest.push(sentFrom?1:0);
    labelsOps.push(h);

    // Gravidade
    if (tRest===0){
      if (!receiverActive){
        const candidates = Object.keys(R).filter(k => k!==currentSender)
          .sort((a,b)=>{
            const dif = R[a]-R[b];
            if (Math.abs(dif) > EPS) return dif;
            return (h - lastRecv[b]) - (h - lastRecv[a]);
          });
        receiverActive = candidates[0] || null;
      }
      if (receiverActive && receiverActive===currentSender){
        if (gravSessionFlag){ tRest = restH; gravSessionFlag=false; }
        receiverActive=null;
      }
      if (receiverActive){
        const dH = TM - R[receiverActive];
        const flow = flowByGravity(dH);
        if (flow >= 200){
          const dHrec = flow / AR;
          const dH0   = flow / A0;
          const canRecv = (R[receiverActive] + dHrec) <= hRmax;
          const canTM   = (TM - dH0) >= 0.0;
          if (canRecv && canTM){
            R[receiverActive] += dHrec;
            TM                 -= dH0;
            lastRecv[receiverActive] = h;
            didGrav = true; gravSessionFlag = true;
            flowGrav = flow;
            actions.push(`<span class="pill p-grav">Gravidade: T-M → ${nameMap[receiverActive]} (${Math.round(flow)} m³)</span>`);
          } else {
            if (gravSessionFlag){ tRest = restH; gravSessionFlag=false; }
            receiverActive=null;
          }
        } else {
          if (gravSessionFlag){ tRest = restH; gravSessionFlag=false; }
          receiverActive=null;
        }
      }
    }
    sOpGrav.push(didGrav?1:0);

    if (gravSessionFlag && !didGrav && tRest===0){ tRest = restH; gravSessionFlag=false; receiverActive=null; }

    TM   = clamp(TM, 0, hT0);
    R.T1 = clamp(R.T1, 0, hRmax);
    R.T2 = clamp(R.T2, 0, hRmax);
    R.T3 = clamp(R.T3, 0, hRmax);

    // estados Gantt
    if (tRest>0) stTM.push('rest');
    else if (didGrav) stTM.push('feed');
    else stTM.push('wait');

    ['T1','T2','T3'].forEach(k=>{
      if (didGrav && receiverActive===k) {
        if (k==='T1') stT1.push('fill');
        if (k==='T2') stT2.push('fill');
        if (k==='T3') stT3.push('fill');
      } else if (currentSender===k) {
        if (k==='T1') stT1.push('feedCdu');
        if (k==='T2') stT2.push('feedCdu');
        if (k==='T3') stT3.push('feedCdu');
      } else {
        if (k==='T1') stT1.push('wait');
        if (k==='T2') stT2.push('wait');
        if (k==='T3') stT3.push('wait');
      }
    });

    // sessões de gravidade
    if (didGrav){
      if (!inTrans || (transObj && transObj.receiver !== receiverActive)){
        if (inTrans && transObj){
          transObj.endH = h; // fecha na borda da hora atual
          gravTransfers.push({...transObj});
        }
        transObj = { startH: h-1, endH: null, receiver: receiverActive, totalM3: 0, hours: 0 };
        inTrans = true;
      }
      if (transObj){
        transObj.totalM3 += flowGrav;
        transObj.hours += 1;
      }
    } else {
      if (inTrans && transObj){
        transObj.endH = h;
        gravTransfers.push({...transObj});
        inTrans=false; transObj=null;
      }
    }

    // séries (após aplicar hora h)
    labelsLvl.push(h);
    sTMVol.push(TM * A0);
    sT1.push(R.T1); sT2.push(R.T2); sT3.push(R.T3);

    const janela = hourLabelRange(h-1);
    let resumo = currentSender ? `CDU atendida por ${nameMap[currentSender]}. ` : `Sem envio à CDU. `;
    if (didGrav){ resumo += `Gravidade ativa (T-M enchendo ${nameMap[receiverActive]}). `; }
    else if (tRest>0){ resumo += `T-M em descanso (${tRest} h restantes). `; }

    rows.push({
      janela, resumo: resumo.trim(),
      actions: actions.length ? actions.join(' · ') : '—',
      TM: TM.toFixed(3), T1: R.T1.toFixed(3), T2: R.T2.toFixed(3), T3: R.T3.toFixed(3),
    });
  }
  if (inTrans && transObj){ transObj.endH = hours; gravTransfers.push({...transObj}); }

  // KPIs
  const nTrans = gravTransfers.length;
  const sumM3 = gravTransfers.reduce((acc,t)=>acc+t.totalM3,0);
  const avgM3 = nTrans? (sumM3/nTrans) : 0;
  document.getElementById('avgM3').textContent = fmt(avgM3,2);
  document.getElementById('avgBBL').textContent = fmt(avgM3/BBL_M3,0);
  document.getElementById('numTrans').textContent = nTrans;

  if (!servedBefore){
    document.getElementById('statusCDU').innerHTML = `<span class="err">Nunca atendida</span>`;
    document.getElementById('firstStop').textContent = '—';
  } else if (firstStopAt===null){
    document.getElementById('statusCDU').innerHTML = `<span class="ok">CDU 100% atendida</span>`;
    document.getElementById('firstStop').textContent = '—';
  } else {
    document.getElementById('statusCDU').innerHTML = `<span class="warn">Interrupção após atendimento</span>`;
    document.getElementById('firstStop').textContent = hourStartLabel(firstStopAt);
  }

  renderCharts(labelsLvl, sTMVol, sT1, sT2, sT3, labelsOps, sOpDest, sOpGrav, cfg.flowDest, hours);
  renderTable(rows);
  renderTransfersTable(gravTransfers);
  prepararSliders(labelsLvl.length, labelsOps.length, false, hours);
  prepareGantt({stTM, stT1, stT2, stT3, hours});
}

/* ===== Render de gráficos ===== */
function renderCharts(labelsLvl, t0vol, t1, t2, t3, labelsOps, opDest, opGrav, flowDest, hours){
  if (chT0Vol) chT0Vol.destroy();
  if (chLv) chLv.destroy();
  if (chOps) chOps.destroy();

  const baseOpts = {
    responsive:true, maintainAspectRatio:false, normalized:true,
    layout:{padding:{top:20,right:10,bottom:8,left:10}},
    plugins:{
      legend:{labels:{usePointStyle:true, boxWidth:8, color:C.inkMuted}},
      zoom:{pan:{enabled:true, mode:'xy'}, zoom:{wheel:{enabled:true}, pinch:{enabled:true}, mode:'xy'}}
    },
    interaction:{mode:'nearest', intersect:false}
  };

  chT0Vol = new Chart(document.getElementById('chartT0Vol'),{
    type:'line',
    data:{ labels:labelsLvl, datasets:[{label:'T-M (volume m³)', data:t0vol, borderColor:C.s2, backgroundColor:"transparent", borderWidth:2.5, tension:.25, pointRadius:0, cubicInterpolationMode:'monotone'}]},
    options:{
      ...baseOpts,
      scales:{
        x:{title:{display:true,text:'hora (0…N)', color:C.inkMuted}, grid:gridDark, ticks:tickCfg, min:0, max:hours},
        y:{title:{display:true,text:'m³', color:C.inkMuted}, grid:gridDark, beginAtZero:true, ticks:{padding:6}}
      }
    }
  });

  chLv = new Chart(document.getElementById('chartLevels'),{
    type:'line',
    data:{ labels:labelsLvl,
      datasets:[
        {label:'T-54 (m)', data:t1, borderColor:C.s1,    backgroundColor:"transparent", borderWidth:2, tension:.25, pointRadius:0, cubicInterpolationMode:'monotone'},
        {label:'T-55 (m)', data:t2, borderColor:C.green, backgroundColor:"transparent", borderWidth:2, tension:.25, pointRadius:0, cubicInterpolationMode:'monotone'},
        {label:'T-56 (m)', data:t3, borderColor:C.s3,    backgroundColor:"transparent", borderWidth:2, tension:.25, pointRadius:0, cubicInterpolationMode:'monotone'}
      ]},
    options:{
      ...baseOpts,
      scales:{
        x:{title:{display:true,text:'hora (0…N)', color:C.inkMuted}, grid:gridDark, ticks:tickCfg, min:0, max:hours},
        y:{title:{display:true,text:'m',    color:C.inkMuted}, grid:gridDark, beginAtZero:true, ticks:{padding:6}, suggestedMax: 21.3}
      }
    }
  });

  chOps = new Chart(document.getElementById('chartOps'),{
    type:'bar',
    data:{ labels:labelsOps,
      datasets:[
        {label:`CDU (flag ${flowDest} m³/h)`, data:opDest, backgroundColor:C.s4, stack:'ops'},
        {label:'Gravidade T-M→Tn',           data:opGrav, backgroundColor:C.s1, stack:'ops'}
      ]},
    options:{
      ...baseOpts,
      scales:{
        x:{title:{display:true,text:'hora (1…N)', color:C.inkMuted}, grid:gridDark, ticks:tickCfg, min:1, max:labelsOps.length},
        y:{title:{display:true,text:'flag', color:C.inkMuted}, grid:gridDark, ticks:{stepSize:1, callback:v=>v|0}, min:0, max:1}
      }
    }
  });
}

function renderTable(rows){
  const tbody = document.querySelector('#tabOps tbody');
  tbody.innerHTML = '';
  const frag = document.createDocumentFragment();
  rows.forEach(r=>{
    const tr = document.createElement('tr');
    tr.innerHTML = `<td>${r.janela}</td>
      <td>${r.resumo}</td>
      <td>${r.actions}</td>
      <td class="num">${r.TM}</td><td class="num">${r.T1}</td><td class="num">${r.T2}</td><td class="num">${r.T3}</td>`;
    frag.appendChild(tr);
  });
  tbody.appendChild(frag);
}

/* ===== Tabela Transferências ===== */
function renderTransfersTable(list){
  const tbody = document.querySelector('#tabTrans tbody');
  tbody.innerHTML = '';
  const frag = document.createDocumentFragment();
  list.forEach(t=>{
    const dur = t.hours;
    const totM3 = t.totalM3;
    const totBBL = totM3/BBL_M3;
    const qAvgM3 = dur>0 ? totM3/dur : 0;
    const qAvgBBL = qAvgM3/BBL_M3;
    const tr = document.createElement('tr');
    tr.innerHTML = `<td>${hourStartLabel(t.startH)}</td>
      <td>${hourStartLabel(t.endH)}</td>
      <td>${nameMap[t.receiver]}</td>
      <td class="num">${fmt(dur,0)}</td>
      <td class="num">${fmt(totM3,2)}</td>
      <td class="num">${fmt(totBBL,0)}</td>
      <td class="num">${fmt(qAvgM3,2)}</td>
      <td class="num">${fmt(qAvgBBL,0)}</td>`;
    frag.appendChild(tr);
  });
  tbody.appendChild(frag);
}

/* ===== Sliders & limites sincronizados ===== */
function setRange(el, min, max, value){
  el.min = String(min);
  el.max = String(max);
  const v = Math.min(Math.max(value, min), max);
  el.value = String(v);
}

function prepararSliders(nLevels, nOps, resetOnly=false, hours=0){
  const xStart1=document.getElementById('xStart1'), xSpan1=document.getElementById('xSpan1'), yMax1=document.getElementById('yMax1');
  const xStart2=document.getElementById('xStart2'), xSpan2=document.getElementById('xSpan2'), yMax2=document.getElementById('yMax2');
  const xStart3=document.getElementById('xStart3'), xSpan3=document.getElementById('xSpan3');
  const gStart=document.getElementById('gStart'), gSpan=document.getElementById('gSpan');

  const totalLvl = (hours>0) ? (hours+1) : (chT0Vol ? chT0Vol.data.labels.length : 241);
  const totalOps = (hours>0) ? hours     : (chOps   ? chOps.data.labels.length   : 240);

  const span1Default = Math.min( Math.max(10, Math.round(totalLvl/4)), totalLvl-1 );
  setRange(xSpan1,  1, Math.max(1,totalLvl-1), xSpan1.value?+xSpan1.value:span1Default);
  const maxStart1 = Math.max(0,(totalLvl-1) - (+xSpan1.value));
  setRange(xStart1, 0, maxStart1, xStart1.value?+xStart1.value:0);
  setRange(yMax1,  1000, 60000, yMax1.value?+yMax1.value:50000);

  const span2Default = Math.min( Math.max(10, Math.round(totalLvl/4)), totalLvl-1 );
  setRange(xSpan2, 1, Math.max(1,totalLvl-1), xSpan2.value?+xSpan2.value:span2Default);
  const maxStart2 = Math.max(0,(totalLvl-1) - (+xSpan2.value));
  setRange(xStart2, 0, maxStart2, xStart2.value?+xStart2.value:0);
  setRange(yMax2, 5, 30, yMax2.value?+yMax2.value:22);

  const span3Default = Math.min( Math.max(10, Math.round(totalOps/4)), Math.max(10,totalOps) );
  setRange(xSpan3, 1, Math.max(1,totalOps), xSpan3.value?+xSpan3.value:span3Default);
  const maxStart3 = Math.max(1, totalOps - (+xSpan3.value) + 1);
  setRange(xStart3, 1, Math.max(1,maxStart3), xStart3.value?+xStart3.value:1);

  const gSpanDefault = Math.min( Math.max(10, Math.round(totalOps/4)), Math.max(10,totalOps) );
  setRange(gSpan,  10, Math.max(10,totalOps), gSpan.value?+gSpan.value:gSpanDefault);
  const gMaxStart = Math.max(1, totalOps - (+gSpan.value) + 1);
  setRange(gStart, 1, Math.max(1,gMaxStart), gStart.value?+gStart.value:1);

  const applyX=(chart,xStartEl,xSpanEl,minLabel)=>{
    const total=chart.data.labels.length;
    const span=parseInt(xSpanEl.value,10);
    const maxStart = (total-1) - span + (minLabel===1?1:0);
    const min = minLabel;
    const start = Math.min(Math.max(parseInt(xStartEl.value,10), min), Math.max(min, maxStart));
    xStartEl.value = String(start);
    chart.options.scales.x.min = min;
    chart.options.scales.x.max = (minLabel===1) ? Math.min(start + span - 1, total) : Math.min(start + span, total-1);
    chart.update('none');
  };
  const applyY=(chart,yMaxEl)=>{ chart.options.scales.y.min = 0; chart.options.scales.y.max = parseFloat(yMaxEl.value); chart.update('none'); };

  const onX1=()=>applyX(chT0Vol,xStart1,xSpan1,0);
  const onX2=()=>applyX(chLv,   xStart2,xSpan2,0);
  const onX3=()=>applyX(chOps,  xStart3,xSpan3,1);
  const onY1=()=>applyY(chT0Vol,yMax1);
  const onY2=()=>applyY(chLv,   yMax2);
  [xStart1,xSpan1].forEach(el=>el.oninput=onX1);
  [xStart2,xSpan2].forEach(el=>el.oninput=onX2);
  [xStart3,xSpan3].forEach(el=>el.oninput=onX3);
  yMax1.oninput=onY1; yMax2.oninput=onY2;

  if (chT0Vol) onX1();
  if (chLv)    onX2();
  if (chOps)   onX3();
  if (chT0Vol) onY1();
  if (chLv)    onY2();

  const onG=()=> renderGanttWindow();
  gStart.oninput=onG; gSpan.oninput=onG;
  onG();
}

/* ===== Conversões em tempo real ===== */
function updateConversions(){
  const flowDest = parseFloat(document.getElementById('flowDest').value);
  const initT1   = parseFloat(document.getElementById('initT1').value);
  const initT2   = parseFloat(document.getElementById('initT2').value);
  const initT3   = parseFloat(document.getElementById('initT3').value);
  const areaR = Math.PI * (dTr*dTr) / 4;
  const v1 = Number.isFinite(initT1) ? areaR*initT1 : NaN;
  const v2 = Number.isFinite(initT2) ? areaR*initT2 : NaN;
  const v3 = Number.isFinite(initT3) ? areaR*initT3 : NaN;
  const b1 = Number.isFinite(v1) ? v1/BBL_M3 : NaN;
  const b2 = Number.isFinite(v2) ? v2/BBL_M3 : NaN;
  const b3 = Number.isFinite(v3) ? v3/BBL_M3 : NaN;
  const bpd = Number.isFinite(flowDest) ? (flowDest*24)/BBL_M3 : NaN;
  document.getElementById('convQ').innerHTML  = `≈ <b>${fmt(bpd,0)} bpd</b>`;
  document.getElementById('convT1').innerHTML = `Volume T-54: <b>${fmt(v1,2)} m³</b> • <b>${fmt(b1,0)} bbl</b>`;
  document.getElementById('convT2').innerHTML = `Volume T-55: <b>${fmt(v2,2)} m³</b> • <b>${fmt(b2,0)} bbl</b>`;
  document.getElementById('convT3').innerHTML = `Volume T-56: <b>${fmt(v3,2)} m³</b> • <b>${fmt(b3,0)} bbl</b>`;
}
['flowDest','initT1','initT2','initT3'].forEach(id=>{
  document.addEventListener('input', e => { if (e.target && e.target.id === id) updateConversions(); });
});
window.addEventListener('DOMContentLoaded', updateConversions);

/* ===== Gantt (SVG) ===== */
let G_DATA=null;
function prepareGantt(payload){
  G_DATA = payload; // {stTM, stT1, stT2, stT3, hours}
  renderGanttWindow();
}
function renderGanttWindow(){
  if (!G_DATA) return;
  const {stTM, stT1, stT2, stT3, hours} = G_DATA;
  const gStart=parseInt(document.getElementById('gStart').value,10) || 1;
  const gSpan =parseInt(document.getElementById('gSpan').value,10)  || Math.min(60, hours);
  const start = Math.max(1, Math.min(gStart, hours));
  const end   = Math.min(hours, start + gSpan - 1);
  const svg   = document.getElementById('ganttSvg');
  const box   = svg.getBoundingClientRect();
  const W = Math.max(300, box.width|0), H = 220;
  const L = 80, R = 6, T = 20, B = 28;
  const innerW = W - L - R, innerH = H - T - B;
  const rows = [
    {key:'TM',  label:'T-M',   data:stTM},
    {key:'T1',  label:'T-54',  data:stT1},
    {key:'T2',  label:'T-55',  data:stT2},
    {key:'T3',  label:'T-56',  data:stT3},
  ];
  const rowH = innerH / rows.length;

  const span = (end - start + 1);
  const xScale = (h)=> L + ( (h - start) * (innerW/span) );
  const wSlot  = innerW / span;

  const fillTM = s => (s==='feed'? getComputedStyle(document.documentElement).getPropertyValue('--brand-gold').trim() || '#D09D44'
                      : s==='rest'? C.rest : C.tmWait);
  const fillTX = s => (s==='fill'? C.green : (s==='feedCdu'? C.s3 : C.wait));

  svg.innerHTML='';
  svg.setAttribute('viewBox', `0 0 ${W} ${H}`);
  const gBg = document.createElementNS('http://www.w3.org/2000/svg','rect');
  gBg.setAttribute('x','0'); gBg.setAttribute('y','0'); gBg.setAttribute('width',W); gBg.setAttribute('height',H);
  gBg.setAttribute('fill', getComputedStyle(document.documentElement).getPropertyValue('--bg-2').trim() || '#121212');
  svg.appendChild(gBg);

  for (let h=start; h<=end; h++){
    const x = xScale(h);
    const vline = document.createElementNS('http://www.w3.org/2000/svg','line');
    vline.setAttribute('x1', x); vline.setAttribute('x2', x);
    vline.setAttribute('y1', T); vline.setAttribute('y2', H-B+4);
    vline.setAttribute('stroke', C.grid); vline.setAttribute('stroke-width','1');
    svg.appendChild(vline);
    if ((h-start)%Math.ceil(span/12)===0 || h===start || h===end){
      const tx = document.createElementNS('http://www.w3.org/2000/svg','text');
      tx.setAttribute('x', x + 2); tx.setAttribute('y', H-8);
      tx.setAttribute('fill', C.inkMuted); tx.setAttribute('font-size','11'); tx.textContent = h;
      svg.appendChild(tx);
    }
  }
  rows.forEach((row, i)=>{
    const yTop = T + i*rowH + 6;
    const tx = document.createElementNS('http://www.w3.org/2000/svg','text');
    tx.setAttribute('x', 8); tx.setAttribute('y', yTop + rowH/2);
    tx.setAttribute('fill', C.inkOn); tx.setAttribute('font-size','12'); tx.setAttribute('dominant-baseline','middle');
    tx.textContent = row.label;
    svg.appendChild(tx);

    const data = row.data;
    let segStart = start, segState = data[start-1];
    for (let h=start+1; h<=end+1; h++){
      const stPrev = segState;
      const stNow  = (h<=end)? data[h-1] : null;
      if (stNow!==stPrev){
        const x = xScale(segStart);
        const w = (h - segStart) * wSlot;
        const rect = document.createElementNS('http://www.w3.org/2000/svg','rect');
        rect.setAttribute('x', x+1);
        rect.setAttribute('y', yTop);
        rect.setAttribute('width', Math.max(0,w-2));
        rect.setAttribute('height', rowH-12);
        const fill = row.key==='TM' ? fillTM(stPrev) : fillTX(stPrev);
        rect.setAttribute('fill', fill);
        rect.setAttribute('rx','3'); rect.setAttribute('ry','3');
        svg.appendChild(rect);
        segStart = h;
        segState = stNow;
      }
    }
  });
}

/* ===== Ranges iniciais (antes da 1ª simulação) ===== */
function setRange(el, min, max, value){
  el.min = String(min); el.max = String(max); el.value = String(Math.min(Math.max(value,min),max));
}
function updateHoursSlidersOnLoad(){
  setRange(document.getElementById('xStart1'), 0, 180, 0);
  setRange(document.getElementById('xSpan1'),  1, 240, 60);
  setRange(document.getElementById('yMax1'), 1000, 60000, 50000);

  setRange(document.getElementById('xStart2'), 0, 180, 0);
  setRange(document.getElementById('xSpan2'),  1, 240, 60);
  setRange(document.getElementById('yMax2'), 5, 30, 22);

  setRange(document.getElementById('xStart3'), 1, 181, 1);
  setRange(document.getElementById('xSpan3'),  1, 240, 60);

  setRange(document.getElementById('gStart'), 1, 181, 1);
  setRange(document.getElementById('gSpan'),  10, 240, 60);
}
window.addEventListener('DOMContentLoaded', updateHoursSlidersOnLoad);
</script>
</body>
</html>
